# TASK-13: Unit Test Suite

## Cel

Kompletne testy jednostkowe dla całego crate.

## Pliki

- Testy w `#[cfg(test)]` w każdym module
- Dodatkowe testy w `tests/`

## Zakres

- [ ] Wire format tests
- [ ] Frame buffer tests
- [ ] Codec tests (raw + msgpack)
- [ ] Handler registry tests
- [ ] RequestContext tests
- [ ] Client builder tests
- [ ] Coverage > 80%

## Checklist testów

### 1. Protocol (wire_format.rs)

- [ ] `encode_header` produces 11 bytes
- [ ] `decode_header` round-trip
- [ ] Big Endian byte order verification
- [ ] Method ID 0 rejected by validate
- [ ] Method ID 0xFFFF accepted (ABORT)
- [ ] Max payload validation
- [ ] All flag combinations

### 2. Protocol (frame_buffer.rs)

- [ ] Single complete frame extraction
- [ ] Multiple frames in one push
- [ ] Fragmented header (5 bytes, then 6 bytes)
- [ ] Fragmented payload
- [ ] Empty payload (payloadLength = 0)
- [ ] Large payload (1MB+)
- [ ] Buffer reset after extraction

### 3. Protocol (frame.rs)

- [ ] Frame creation
- [ ] Convenience methods (is_response, is_error, etc.)
- [ ] build_frame produces valid bytes
- [ ] Zero-copy payload sharing

### 4. Codec (raw.rs)

- [ ] Pass-through serialization
- [ ] Empty buffer
- [ ] Large buffer

### 5. Codec (msgpack.rs)

- [ ] Simple struct round-trip
- [ ] Nested objects
- [ ] Arrays / Vec
- [ ] Option::None → MsgPack nil
- [ ] Number types (i64, u64, f64)
- [ ] **Interop test:** Node.js generated bytes

### 6. Handler (registry.rs)

- [ ] Method registration
- [ ] Event registration
- [ ] ID assignment (sequential from 1)
- [ ] Lookup by name
- [ ] Lookup by ID
- [ ] build_schema correctness

### 7. Handler (context.rs)

- [ ] respond() correct flags (0x03)
- [ ] ack() correct flags (0x23)
- [ ] ack_empty() correct flags + empty payload
- [ ] chunk() correct flags (0x0B)
- [ ] end() correct flags (0x1B) + empty payload
- [ ] error() correct flags (0x07)
- [ ] Double respond() returns error
- [ ] chunk() allows multiple calls

### 8. Client (client.rs)

- [ ] Builder fluent API
- [ ] handle() registers with Result type
- [ ] handle_stream() registers with Stream type
- [ ] event() registers event

## Komendy

```bash
# Run all tests
cargo test

# Run with output
cargo test -- --nocapture

# Run specific module tests
cargo test protocol::wire_format
cargo test codec::msgpack

# Coverage (requires cargo-tarpaulin)
cargo tarpaulin --out Html
```

## Definition of Done

- [ ] `cargo test` — ALL PASS
- [ ] Coverage > 80% (mierzone `cargo tarpaulin`)
- [ ] Żadne `#[ignore]` testy bez uzasadnienia
- [ ] Testy są czytelne i dobrze nazwane

## Kontekst

- Testy jednostkowe są fundamentem jakości kodu
- Każdy moduł powinien mieć testy w `#[cfg(test)] mod tests`
- Testy integracyjne i E2E są w osobnych taskach (TASK-14)
